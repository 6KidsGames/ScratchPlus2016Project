<!doctype html>
<!-- Based on Echo sample from Primus. -->
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ScratchPlus Summer 2016 Project</title>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/normalize/3.0.1/normalize.min.css">
  <script src="/primus/primus.js"></script>
  <script src="/scripts/pixi.min.js"></script>
  <style>
    body { padding: 50px }
    #output { width: 450px; height: 200px; display: block; border: 0; outline: 0; margin: 0 0 4px }
    #echo { width: 400px; height: 25px; font-size: 16px }
    button { border-radius: 5px; border: 0; background: #444; color: #FFF; padding: 6px }
  </style>
</head>
<body>
  <form id="write">
    <textarea id="output" readonly></textarea>
    <input placeholder="write message that should echo" id="echo" />
    <button type="submit">echo</button>
  </form>
  
  <p>Use A,S,D,W to move, Space to inflate, E to reset.</p>
  <script>
    var output = document.getElementById('output');
    var echo = document.getElementById('echo');

    // Pixi.js setup - we use Pixi's auto-detect for the browser's capabilities.
    // It will choose a fast WebGL viewport or fall back to HTML5 Canvas. 
    console.log(PIXI);
    var renderer = PIXI.autoDetectRenderer(800, 128, { antialias: false, transparent: false, resolution: 1 });
    renderer.autoResize = true;
    document.body.appendChild(renderer.view);
    renderer.resize(window.innerWidth, 256);
    var stage = new PIXI.Container();
    PIXI.loader
      .add([ "images/BananaDoesNotApprove.png" ])
      .load(setupPixi);

    // Called asynchronously when PIXI.loader.load() has finished loading all textures and we can create sprites.
    var bananaSprite = null;
    function setupPixi() {
      // Image load complete. Create sprites from the tileset.
      console.log("Pixi setup complete, creating stage");
      console.log(PIXI.loader.resources);
      bananaSprite = new PIXI.Sprite(PIXI.loader.resources["images/BananaDoesNotApprove.png"].texture);
      stage.addChild(bananaSprite);

      renderer.render(stage);

      // Run the game loop from here on out.
      gameLoop();
    }

    // Tell Primus to create a new WebSockets connection to the current domain/port/protocol
    var primus = Primus.connect();
    primus.on("open", function () {
      console.log("Primus connected!")
    })

    // Listen for incoming data and log it in our textarea element.
    primus.on('data', function received(data) {
      output.value += data +'\n';
    });

    // Listen for submits of the form so we can send the message to the server.
    document.getElementById('write').onsubmit = function submit(e) {
      if (e && e.preventDefault) {
        e.preventDefault();
      }

      // Write the typed message.
      primus.write(echo.value);
      echo.value = '';
    };

    // Helpers that track the state of keyboard keys by hooking the current window's key events
    // and tracking if a key down or up has occurred.
    var keyPressed = [];
    window.onkeyup = function(keyEvent) { /*console.log("keyup: " + keyEvent.keyCode);*/ keyPressed[keyEvent.keyCode] = false; }
    window.onkeydown = function(keyEvent) { /*console.log("keydown: " + keyEvent.keyCode);*/ keyPressed[keyEvent.keyCode] = true; }

    // Key codes. Full table at http://www.cambiaresearch.com/articles/15/javascript-key-codes
    var KEY_W = 87;
    var KEY_S = 83;
    var KEY_A = 65;
    var KEY_D = 68;
    var KEY_SPACE = 32;
    var KEY_E = 69;

    function gameLoop() {
      // This call returns when we're at the beginning of the next frame time.
      // Rendering is at 60 frames per second by default, which is fast enough not to appear flickery.
      requestAnimationFrame(gameLoop);

      // Make changes to sprites.
      if (keyPressed[KEY_W]) { bananaSprite.y -= 1; }
      if (keyPressed[KEY_S]) { bananaSprite.y += 1; }
      if (keyPressed[KEY_A]) { bananaSprite.x -= 1; }
      if (keyPressed[KEY_D]) { bananaSprite.x += 1; }
      if (keyPressed[KEY_SPACE]) { bananaSprite.scale.x *= 1.01; bananaSprite.scale.y *= 1.01; }
      if (keyPressed[KEY_E]) {
        bananaSprite.scale.x = 1;
        bananaSprite.scale.y = 1;
        bananaSprite.x = 0;
        bananaSprite.y = 0;
      }

      // Render the results to the stage.
      renderer.render(stage);
    }
  </script>
</body>
</html>
